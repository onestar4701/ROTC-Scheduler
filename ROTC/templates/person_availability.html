{% extends 'base.html' %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>{{ person.name }} - 주간 가능 시간 설정</h2>
        <a href="{{ url_for('people_list') }}" class="btn" style="background: #e2e8f0;">목록으로</a>
    </div>

    <p class="text-muted" style="margin-bottom: 20px;">
        드래그하여 가능한 시간을 선택하세요 (초록색 = 가능).
    </p>

    <form method="POST" id="availabilityForm">
        <!-- Hidden inputs to store serialized data -->
        {% for i in range(7) %}
        <input type="hidden" name="day_{{ i }}" id="input_day_{{ i }}" value="{{ avail_map.get(i, '') }}">
        {% endfor %}

        <div class="time-grid" id="timeGrid" data-readonly="{{ 'true' if readonly else 'false' }}">
            <!-- Header Row -->
            <div class="grid-header"></div> <!-- Empty corner -->
            {% for day in days %}
            <div class="grid-header">{{ day }}</div>
            {% endfor %}

            <!-- Time Rows (06:00 to 00:00) -->
            {% for hour in range(6, 25) %}
            <div class="time-label">{{ hour }}:00</div>
            {% for day in range(7) %}
            <div class="grid-cell" data-day="{{ day }}" data-hour="{{ hour }}"></div>
            {% endfor %}
            {% endfor %}
        </div>

        <div style="margin-top: 20px; text-align: right;">
            <button type="submit" class="btn btn-primary">저장하기</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const grid = document.getElementById('timeGrid');
        const isReadOnly = grid.dataset.readonly === 'true';

        let isMouseDown = false;
        let isSelecting = true;

        // Load initial data
        for (let i = 0; i < 7; i++) {
            const input = document.getElementById(`input_day_${i}`);
            if (input.value) {
                const hours = input.value.split(',');
                hours.forEach(h => {
                    const cell = document.querySelector(`.grid-cell[data-day="${i}"][data-hour="${h}"]`);
                    if (cell) cell.classList.add('selected');
                });
            }
        }

        if (isReadOnly) {
            // Disable interactions
            grid.style.pointerEvents = 'none';
            grid.style.opacity = '0.8';
            document.querySelector('.text-muted').textContent = "(읽기 전용 모드입니다)";
            const submitBtn = document.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.style.display = 'none';
            return;
        }

        grid.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('grid-cell')) {
                isMouseDown = true;
                isSelecting = !e.target.classList.contains('selected');
                toggleCell(e.target);
                e.preventDefault();
            }
        });

        grid.addEventListener('mouseover', (e) => {
            if (isMouseDown && e.target.classList.contains('grid-cell')) {
                toggleCell(e.target);
            }
        });

        document.addEventListener('mouseup', () => {
            isMouseDown = false;
            serializeData();
        });

        function toggleCell(cell) {
            if (isSelecting) {
                cell.classList.add('selected');
            } else {
                cell.classList.remove('selected');
            }
        }

        function serializeData() {
            for (let i = 0; i < 7; i++) {
                const selectedCells = document.querySelectorAll(`.grid-cell[data-day="${i}"].selected`);
                const hours = Array.from(selectedCells).map(cell => cell.dataset.hour).join(',');
                document.getElementById(`input_day_${i}`).value = hours;
            }
        }

        // Initial serialize to ensure consistency
        serializeData();
    });
</script>
{% endblock %}