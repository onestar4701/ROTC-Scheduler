{% extends 'base.html' %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>{{ roster.title }} - ì‹œê°„ë³„ ì¸ì› ì„¤ì •</h2>
        <form action="{{ url_for('save_roster_capacity', id=roster.id) }}" method="POST">
            <!-- Hidden inputs for data -->
            <input type="hidden" name="capacity_data" id="capacity_data">
            <button type="submit" class="btn btn-primary" onclick="prepareData(event)">ì €ì¥ ë° ë°°ì • í™”ë©´ìœ¼ë¡œ ì´ë™</button>
        </form>
    </div>

    <div class="alert"
        style="background: #f0f9ff; border: 1px solid #bae6fd; padding: 15px; margin-bottom: 20px; border-radius: 6px;">
        <p style="margin: 0; color: #0369a1;">
            <strong>ğŸ’¡ ì„¤ì • ë°©ë²•:</strong> ê° ì‹œê°„ëŒ€ë³„ë¡œ í•„ìš”í•œ ì¸ì› ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”. <br>
            ìë™ ë°°ì • ì‹œ ì´ ì„¤ì •ì— ë§ì¶° ì¸ì›ì´ ë°°ì •ë©ë‹ˆë‹¤. (ê¸°ë³¸ê°’: {{ roster.people_per_shift or 'ì œí•œ ì—†ìŒ' }})
        </p>
    </div>

    <div style="overflow-x: auto;">
        <table class="roster-table" style="width: 100%; border-collapse: collapse; min-width: 800px;">
            <thead>
                <tr>
                    <th style="width: 60px; background: #f8fafc; border: 1px solid #e2e8f0;">Time</th>
                    {% for day in days %}
                    {% set day_names = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'] %}
                    <th style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 8px; text-align: center;">
                        {{ day.strftime('%m/%d') }} ({{ day_names[day.weekday()] }})
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for hour in range(6, 25) %}
                <tr>
                    <td
                        style="text-align: center; font-size: 0.8rem; color: #64748b; border: 1px solid #e2e8f0; padding: 4px; background: #f8fafc;">
                        {{ hour }}:00
                    </td>
                    {% for day in days %}
                    {% set date_str = day.strftime('%Y-%m-%d') %}
                    <!-- Pre-fill with existing slot data or default -->
                    {% set slot_key = (day, hour) %}
                    {% set count = slot_map.get(slot_key, roster.people_per_shift or 1) %}
                    <td style="border: 1px solid #e2e8f0; padding: 0; height: 40px; text-align: center;">
                        <input type="number" class="capacity-input" data-date="{{ date_str }}" data-hour="{{ hour }}"
                            value="{{ count }}" min="1"
                            style="width: 100%; height: 100%; border: none; text-align: center; font-size: 1rem; color: #0284c7; font-weight: bold; background: transparent;">
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function prepareData(event) {
        event.preventDefault();

        const inputs = document.querySelectorAll('.capacity-input');
        const data = [];

        inputs.forEach(input => {
            data.push({
                date: input.dataset.date,
                hour: input.dataset.hour,
                count: input.value
            });
        });

        document.getElementById('capacity_data').value = JSON.stringify(data);
        event.target.form.submit();
    }

    // Auto-select on focus
    document.querySelectorAll('.capacity-input').forEach(input => {
        input.addEventListener('focus', function () {
            this.select();
        });
    });
</script>
{% endblock %}