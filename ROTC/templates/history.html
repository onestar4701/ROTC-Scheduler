{% extends 'base.html' %}

{% block content %}
<div class="card">
    <h2>근무 통계 (Duty Statistics)</h2>
    <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px;">
        <div style="flex: 1; min-width: 400px;">
            <div style="position: relative; height: 400px;">
                <canvas id="dutyChart"></canvas>
            </div>
        </div>
        <div style="flex: 1; min-width: 300px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8fafc; text-align: left;">
                        <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">이름 (Name)</th>
                        <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">근무 시간 (Hours)</th>
                        <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">최근 근무 (Recent)</th>
                        <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">통계 초기화</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in stats %}
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 12px; font-weight: 500;">{{ stat.person.name }}</td>
                        <td style="padding: 12px;">{{ stat.count }}시간</td>
                        <td style="padding: 12px; font-size: 0.9rem; color: #64748b;">
                            {% for duty in stat.recent_duties %}
                            <span style="margin-right: 5px;">{{ duty.date.strftime('%m/%d') }}</span>
                            {% endfor %}
                        </td>
                        <td style="padding: 12px;">
                            {% if current_user.role == 'admin' %}
                            <form method="POST" action="{{ url_for('reset_stats', id=stat.person.id) }}"
                                style="display: inline;">
                                <button type="submit"
                                    onclick="return confirm('{{ stat.person.name }}님의 통계를 초기화하시겠습니까?')"
                                    style="padding: 4px 8px; border: 1px solid #cbd5e1; background: white; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                                    초기화
                                </button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script type="application/json" id="chart-data">
    {
        "labels": {{ labels|tojson }},
        "data": {{ data|tojson }},
        "colors": {{ colors|tojson }}
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chartData = JSON.parse(document.getElementById('chart-data').textContent);
        const { labels, data, colors } = chartData;

        console.log('Chart data:', chartData);

        const ctx = document.getElementById('dutyChart');
        if (ctx) {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '근무 시간 (Hours)',
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 1,
                        borderColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
            console.log('Chart created successfully');
        } else {
            console.error('Canvas element not found');
        }
    });
</script>
{% endblock %}